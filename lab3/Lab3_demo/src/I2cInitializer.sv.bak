module I2cInitializer (
	input	i_rst_n,
	input	i_clk,
	input	i_start,
	output	o_finished,
	output	o_sclk,
	output	o_sdat,
	output	o_oen
);

logic [23: 0] setting_init[6:0] = {
    24'b00110100_000_1001_0_0000_0001,
    24'b00110100_000_1000_0_0001_1001,
    24'b00110100_000_0111_0_0100_0010,
    24'b00110100_000_0110_0_0000_0000,
    24'b00110100_000_0101_0_0000_0000,
    24'b00110100_000_0100_0_0001_0101,
	24'b00110100_000_1111_0_0000_0000
};

localparam S_IDLE = 0;
localparam S_PROC = 1;

logic [2:0] state_r,state_w;
logic oen_r, oen_w;
logic sdat_r, sdat_w;
logic sclk_r, sclk_w;
logic finish_r, finish_w;
logic [5:0] det_24_r, det_24_w; //detect 24 bits
logic [3:0] det_7_r, det_7_w; //detect 7 cycles

assign o_finished = finish_r;
assign o_sclk = sclk_r;
assign o_sdat = sdat_r;
assign o_oen = oen_r;

always_comb begin
	state_w = state_r;
	sdat_w = sdat_r;
	sclk_w = sclk_r;
	finish_w = finish_r;
	oen_w = oen_r;
	det_24_w = det_24_r;
	det_7_w = det_7_r;
	
	case(state_r)
		S_IDLE: begin
			finish_w = 0;
			oen_w = 1;
			det_24_w = 0;
			det_7_w = 0;
			sclk_w = 1;
			sdat_w = 1;
			if(i_start) begin
				state_w = S_PROC;
				sdat_w = 0;
			end
		end

		S_PROC: begin
			sclk_w = ~sclk_r; // switching between Modify and Output
			if(det_7_r>6) begin
				sclk_w = sclk_r; //end 
                sdat_w = sdat_r; //end
                finish_w = 1;
			end
			else if (sclk_r) begin 
				if (det_24_r % 8 == 0 && det_24_r > 0 && oen_r) begin
					oen_w = 0;
					sdat_w = 1'bz;
					det_24_w = (det_24_r == 24) ? 0 : (det_24_r);
					det_7_w  = (det_24_r == 24) ? (det_7_r+1) : (det_7_r);
				end
				else begin
					oen_w = 1;
					sdat_w = setting_init[6-det_7_r][23-det_24_r];
					det_24_w = det_24_r + 1;
					det_7_w = det_7_r;
				end
				
			end
			state_w = state_r;
		end
	endcase
end
always_ff @(posedge i_clk or negedge i_rst_n) begin
	if(!i_rst_n) begin
		state_r <= S_IDLE;
		det_24_r <= 0;
		det_7_r <= 0;
		sdat_r <= 1;
		sclk_r <= 1;
		finish_r <= 0;
		oen_r <= 1;
	end else begin
		state_r <= state_w;
		det_24_r <= det_24_w;
		det_7_r <= det_7_w;
		sdat_r <= sdat_w;
		sclk_r <= sclk_w;
		finish_r <= finish_w;
		oen_r <= oen_w;
	end
end

endmodule